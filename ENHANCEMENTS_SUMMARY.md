# Transformation Service - Enhancements Summary

## Overview

Three major enhancements have been implemented to improve the Transformation Service's capabilities for ETL operations, scheduled jobs, and rule management.

---

## 1. DAG Auto-Generation API ✅

### What It Does

Automatically generates Airflow DAGs from transformation rule definitions through an API, eliminating manual DAG creation.

### Key Features

- **API-Driven Generation**: Create DAGs via REST API
- **Preview Mode**: Preview generated DAG code before saving
- **Template-Based**: Uses proven Airflow patterns
- **Configurable**: Customize schedule, timeouts, retries, etc.
- **Regeneration**: Update existing DAGs when rules change

### API Endpoints

```
POST   /api/airflow/dags/generate          - Generate new DAG
GET    /api/airflow/dags                   - List all DAG definitions
GET    /api/airflow/dags/{id}              - Get DAG definition
POST   /api/airflow/dags/{id}/regenerate   - Regenerate DAG file
POST   /api/airflow/dags/preview           - Preview DAG code
DELETE /api/airflow/dags/{id}              - Delete DAG definition
```

### Example Usage

```bash
# Generate a new Airflow DAG
curl -X POST http://localhost:5004/api/airflow/dags/generate \
  -H "Content-Type: application/json" \
  -d '{
    "dagId": "user_etl_daily",
    "entityType": "User",
    "description": "Daily ETL for user data",
    "schedule": "0 2 * * *",
    "sparkJobId": 1,
    "configuration": {
      "timeoutSeconds": 1800,
      "pollInterval": 30,
      "retries": 3,
      "owner": "data-team",
      "email": "ops@example.com"
    }
  }'
```

### Generated DAG Example

```python
"""
Daily ETL for user data

Auto-generated by TransformationService
Entity Type: User
Generated: 2025-11-29 12:00:00 UTC
"""

from datetime import datetime, timedelta
from airflow import DAG
from operators.spark_job_operator import SparkJobOperator

default_args = {
    'owner': 'data-team',
    'depends_on_past': False,
    'start_date': datetime(2025, 11, 29),
    'email': ['ops@example.com'],
    'email_on_failure': True,
    'retries': 3,
    'retry_delay': timedelta(minutes=5),
}

with DAG(
    'user_etl_daily',
    default_args=default_args,
    description='Daily ETL for user data',
    schedule_interval='0 2 * * *',
    catchup=False,
    tags=['auto-generated', 'User', 'transformation'],
) as dag:
    
    transform_task = SparkJobOperator(
        task_id='transform_user',
        spark_job_id=1,
        entity_type='User',
        input_data={},
        timeout_seconds=1800,
        poll_interval=30,
        http_conn_id='transformation_service',
    )
```

---

## 2. Transformation Projects ✅

### What It Does

Groups related transformation rules into projects/pipelines for better organization and management.

### Key Features

- **Rule Grouping**: Organize rules into logical projects
- **Execution Order**: Define rule execution sequence
- **Project Execution**: Execute all rules in a project
- **Execution History**: Track project runs
- **Entity-Specific**: Projects tied to entity types

### API Endpoints

```
POST   /api/transformation-projects              - Create project
GET    /api/transformation-projects              - List all projects
GET    /api/transformation-projects/{id}         - Get project details
PUT    /api/transformation-projects/{id}         - Update project
DELETE /api/transformation-projects/{id}         - Delete project
POST   /api/transformation-projects/{id}/rules   - Add rule to project
DELETE /api/transformation-projects/{id}/rules/{ruleId} - Remove rule
PUT    /api/transformation-projects/{id}/rules/order - Reorder rules
POST   /api/transformation-projects/{id}/execute - Execute project
GET    /api/transformation-projects/{id}/executions - Get execution history
```

### Example Usage

```bash
# Create a transformation project
curl -X POST http://localhost:5004/api/transformation-projects \
  -H "Content-Type: application/json" \
  -d '{
    "name": "User Data Enrichment",
    "description": "Enriches user data with validation and normalization",
    "entityType": "User",
    "ruleIds": [1, 2, 3],
    "configuration": {
      "batchSize": 1000,
      "executionMode": "Spark"
    }
  }'

# Execute a project
curl -X POST http://localhost:5004/api/transformation-projects/1/execute \
  -H "Content-Type: application/json" \
  -d '{
    "executionMode": "Spark",
    "timeoutSeconds": 1800,
    "inputData": {
      "source": "user_raw_data",
      "batchSize": 10000
    }
  }'
```

### Database Schema

```sql
-- Projects
TransformationProjects
  - Id
  - Name
  - Description
  - EntityType
  - IsActive
  - Configuration (JSONB)

-- Project-Rule Mapping
TransformationProjectRules
  - ProjectId
  - RuleId
  - ExecutionOrder
  - IsEnabled

-- Execution History
TransformationProjectExecutions
  - ProjectId
  - ExecutionId
  - Status
  - StartedAt
  - CompletedAt
  - RecordsProcessed
  - RecordsFailed
```

---

## 3. Rule Versioning ✅

### What It Does

Tracks transformation rule changes over time with full version history and rollback capability.

### Key Features

- **Automatic Versioning**: Every rule change creates a version
- **Version History**: View all versions of a rule
- **Rollback**: Restore previous versions
- **Diff Comparison**: Compare two versions
- **Audit Trail**: Track who changed what and why

### API Endpoints

```
GET    /api/transformation-rules/{id}/versions           - Get version history
GET    /api/transformation-rules/{id}/versions/{version} - Get specific version
POST   /api/transformation-rules/{id}/versions/rollback/{version} - Rollback
GET    /api/transformation-rules/{id}/versions/diff/{v1}/{v2} - Compare versions
```

### Example Usage

```bash
# Get version history for a rule
curl http://localhost:5004/api/transformation-rules/1/versions

# Rollback to version 3
curl -X POST http://localhost:5004/api/transformation-rules/1/versions/rollback/3 \
  -H "Content-Type: application/json" \
  -d '{
    "changedBy": "admin",
    "reason": "Reverting problematic change"
  }'

# Compare two versions
curl http://localhost:5004/api/transformation-rules/1/versions/diff/2/4
```

### Version Response Example

```json
{
  "id": 5,
  "ruleId": 1,
  "version": 3,
  "name": "Normalize Email",
  "description": "Converts email to lowercase and trims whitespace",
  "ruleType": "JavaScript",
  "configuration": {
    "fieldName": "email",
    "customScript": "data.email = data.email.toLowerCase().trim();"
  },
  "isActive": true,
  "changeType": "Updated",
  "changedBy": "admin",
  "changeReason": "Added trim() function",
  "createdAt": "2025-11-29T10:30:00Z"
}
```

### Diff Response Example

```json
{
  "ruleId": 1,
  "version1": 2,
  "version2": 4,
  "changes": [
    {
      "fieldName": "customScript",
      "oldValue": "data.email = data.email.toLowerCase();",
      "newValue": "data.email = data.email.toLowerCase().trim();",
      "changeType": "Modified"
    },
    {
      "fieldName": "description",
      "oldValue": "Converts email to lowercase",
      "newValue": "Converts email to lowercase and trims whitespace",
      "changeType": "Modified"
    }
  ]
}
```

---

## Integration with Existing Features

### Airflow + Projects + Versioning

```
1. Create transformation rules for User entity
2. Group rules into "User Data Enrichment" project
3. Generate Airflow DAG for the project
4. Schedule DAG to run daily at 2 AM
5. Rules are versioned automatically on changes
6. Regenerate DAG when rules change
7. Rollback rules if issues occur
```

### Complete Workflow Example

```bash
# Step 1: Create transformation rules (already exists)
# Rules: Normalize Email, Validate Phone, Enrich Location

# Step 2: Create a project
curl -X POST http://localhost:5004/api/transformation-projects \
  -H "Content-Type: application/json" \
  -d '{
    "name": "User Data Pipeline",
    "entityType": "User",
    "ruleIds": [1, 2, 3]
  }'

# Step 3: Generate Airflow DAG
curl -X POST http://localhost:5004/api/airflow/dags/generate \
  -H "Content-Type: application/json" \
  -d '{
    "dagId": "user_pipeline_daily",
    "entityType": "User",
    "schedule": "0 2 * * *",
    "transformationProjectId": 1,
    "sparkJobId": 1
  }'

# Step 4: DAG runs automatically at 2 AM daily

# Step 5: Update a rule (version created automatically)
curl -X PUT http://localhost:5004/api/transformation-rules/1 \
  -H "Content-Type: application/json" \
  -d '{
    "customScript": "data.email = data.email.toLowerCase().trim();"
  }'

# Step 6: Regenerate DAG (optional, if needed)
curl -X POST http://localhost:5004/api/airflow/dags/1/regenerate

# Step 7: Rollback if issues occur
curl -X POST http://localhost:5004/api/transformation-rules/1/versions/rollback/2 \
  -H "Content-Type: application/json" \
  -d '{
    "changedBy": "admin",
    "reason": "Reverting to stable version"
  }'
```

---

## Database Migration

### Apply Enhancements

```bash
# Run the migration script
psql -U postgres -d transformation_engine -f src/TransformationEngine.Service/Data/Migrations/add_enhancements.sql
```

### Verify Installation

```sql
-- Check tables exist
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
  AND table_name IN (
    'TransformationProjects',
    'TransformationProjectRules',
    'TransformationProjectExecutions',
    'TransformationRuleVersions',
    'AirflowDagDefinitions'
  );

-- Check version fields added to TransformationRules
SELECT column_name 
FROM information_schema.columns 
WHERE table_name = 'TransformationRules' 
  AND column_name IN ('CurrentVersion', 'LastModifiedBy', 'LastModifiedAt');
```

---

## Configuration

### appsettings.json

```json
{
  "Airflow": {
    "DagsPath": "/opt/airflow/dags",
    "Enabled": true
  },
  "TransformationProjects": {
    "DefaultExecutionMode": "Spark",
    "DefaultTimeout": 1800
  },
  "RuleVersioning": {
    "AutoVersion": true,
    "RetentionDays": 365
  }
}
```

---

## Benefits

### 1. Reduced Manual Work
- No more manual DAG creation
- Automated versioning
- Organized rule management

### 2. Better Governance
- Full audit trail
- Rollback capability
- Version comparison

### 3. Improved Organization
- Logical grouping of rules
- Project-based execution
- Clear execution history

### 4. Enhanced Reliability
- Tested DAG templates
- Consistent patterns
- Error recovery

---

## Next Steps

1. **Test the Enhancements**
   - Create a test project
   - Generate a test DAG
   - Execute and verify

2. **Create UI (Optional)**
   - Project management interface
   - Rule version viewer
   - DAG generator UI

3. **Monitor and Optimize**
   - Track project executions
   - Monitor DAG performance
   - Optimize rule execution order

---

## Support

For issues or questions:
- Check `TROUBLESHOOTING.md`
- Review `ENHANCEMENT_PLAN.md` for design details
- See `IMPLEMENTATION_STATUS.md` for validation

---

**Last Updated**: November 29, 2025  
**Status**: Fully Implemented ✅

