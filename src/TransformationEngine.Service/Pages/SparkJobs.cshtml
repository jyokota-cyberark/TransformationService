@page
@model TransformationEngine.Pages.SparkJobsModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Spark Jobs";
}

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-4">
                <i class="bi bi-lightning-charge"></i> Spark Jobs
            </h1>
            <p class="lead">Monitor and manage Spark job executions</p>
        </div>
        <div class="col-auto">
            <a href="/SparkJobTemplates" class="btn btn-outline-primary">
                <i class="bi bi-file-earmark-code"></i> Templates
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4" id="statisticsCards">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">Total Executions</h5>
                    <h2 id="statTotal" class="mb-0">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">Successful</h5>
                    <h2 id="statSuccessful" class="mb-0">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger">
                <div class="card-body">
                    <h5 class="card-title">Failed</h5>
                    <h2 id="statFailed" class="mb-0">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5 class="card-title">Running</h5>
                    <h2 id="statRunning" class="mb-0">-</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Status Filter</h5>
                    <select id="statusFilter" class="form-select" onchange="loadExecutions()">
                        <option value="">All Statuses</option>
                        <option value="Queued">Queued</option>
                        <option value="Submitting">Submitting</option>
                        <option value="Running">Running</option>
                        <option value="Succeeded">Succeeded</option>
                        <option value="Failed">Failed</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Entity Type</h5>
                    <select id="entityTypeFilter" class="form-select" onchange="loadExecutions()">
                        <option value="">All Types</option>
                        <option value="User">User</option>
                        <option value="Application">Application</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Job Definition</h5>
                    <select id="jobDefinitionFilter" class="form-select" onchange="loadExecutions()">
                        <option value="">All Jobs</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Actions</h5>
                    <button class="btn btn-primary w-100" onclick="loadExecutions()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()">
                        <label class="form-check-label" for="autoRefresh">
                            Auto-refresh (30s)
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Executions Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Job Executions</h5>
                    <span class="badge bg-secondary" id="executionCount">0 executions</span>
                </div>
                <div class="card-body">
                    <div id="loadingIndicator" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading executions...</p>
                    </div>
                    <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>
                    <div class="table-responsive">
                        <table class="table table-hover" id="executionsTable">
                            <thead>
                                <tr>
                                    <th>Execution ID</th>
                                    <th>Job Name</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                    <th>Entity Type</th>
                                    <th>Triggered By</th>
                                    <th>Queued At</th>
                                    <th>Duration</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="executionsTableBody">
                                <tr>
                                    <td colspan="9" class="text-center text-muted py-5">
                                        Loading executions...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination -->
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center" id="pagination">
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<script>
    let currentPage = 1;
    let currentPageSize = 50;
    let autoRefreshInterval = null;

    // Load on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadJobDefinitions();
        loadStatistics();
        loadExecutions();
    });

    // Load job definitions for filter
    async function loadJobDefinitions() {
        try {
            const response = await fetch('/api/spark-job-library');
            if (response.ok) {
                const jobs = await response.json();
                const select = document.getElementById('jobDefinitionFilter');
                jobs.forEach(job => {
                    const option = document.createElement('option');
                    option.value = job.id;
                    option.textContent = job.jobName;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading job definitions:', error);
        }
    }

    // Load statistics
    async function loadStatistics() {
        try {
            const response = await fetch('/api/spark-job-executions/statistics');
            if (response.ok) {
                const stats = await response.json();
                document.getElementById('statTotal').textContent = stats.total || 0;
                document.getElementById('statSuccessful').textContent = stats.successful || 0;
                document.getElementById('statFailed').textContent = stats.failed || 0;
                document.getElementById('statRunning').textContent = stats.running || 0;
            }
        } catch (error) {
            console.error('Error loading statistics:', error);
        }
    }

    // Load executions
    async function loadExecutions() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const tableBody = document.getElementById('executionsTableBody');

        loadingIndicator.style.display = 'block';
        errorMessage.style.display = 'none';
        tableBody.innerHTML = '';

        try {
            const params = new URLSearchParams({
                page: currentPage,
                pageSize: currentPageSize
            });

            const statusFilter = document.getElementById('statusFilter').value;
            const entityTypeFilter = document.getElementById('entityTypeFilter').value;
            const jobDefinitionFilter = document.getElementById('jobDefinitionFilter').value;

            if (statusFilter) params.append('status', statusFilter);
            if (entityTypeFilter) params.append('entityType', entityTypeFilter);
            if (jobDefinitionFilter) params.append('jobDefinitionId', jobDefinitionFilter);

            const response = await fetch(`/api/spark-job-executions?${params}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            displayExecutions(data);
            updatePagination(data);
            document.getElementById('executionCount').textContent = `${data.totalCount} executions`;
        } catch (error) {
            console.error('Error loading executions:', error);
            errorMessage.textContent = `Error loading executions: ${error.message}`;
            errorMessage.style.display = 'block';
        } finally {
            loadingIndicator.style.display = 'none';
        }
    }

    // Display executions in table
    function displayExecutions(data) {
        const tableBody = document.getElementById('executionsTableBody');
        tableBody.innerHTML = '';

        if (!data.Items || data.Items.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-5">No executions found</td></tr>';
            return;
        }

        data.Items.forEach(execution => {
            const row = document.createElement('tr');
            const statusBadge = getStatusBadge(execution.status);
            const progressBar = execution.status === 'Running' || execution.status === 'Submitting' 
                ? `<div class="progress" style="height: 20px;">
                     <div class="progress-bar" role="progressbar" style="width: ${execution.progress}%">${execution.progress}%</div>
                   </div>`
                : execution.progress > 0 ? `${execution.progress}%` : '-';
            
            const duration = execution.durationSeconds 
                ? `${execution.durationSeconds}s`
                : execution.startedAt 
                    ? calculateDuration(execution.startedAt, execution.completedAt)
                    : '-';

            const canCancel = execution.status === 'Queued' || execution.status === 'Submitting' || execution.status === 'Running';

            row.innerHTML = `
                <td><code>${execution.executionId.substring(0, 12)}...</code></td>
                <td>${execution.jobDefinition ? execution.jobDefinition.jobName : 'N/A'}</td>
                <td>${statusBadge}</td>
                <td>${progressBar}</td>
                <td>${execution.entityType ? `<span class="badge bg-info">${execution.entityType}</span>` : '-'}</td>
                <td>${execution.triggeredBy || execution.triggerType}</td>
                <td>${formatDate(execution.queuedAt)}</td>
                <td>${duration}</td>
                <td>
                    <a href="/SparkJobDetails?id=${execution.id}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-eye"></i> View
                    </a>
                    ${canCancel ? `<button class="btn btn-sm btn-outline-danger" onclick="cancelExecution(${execution.id})">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>` : ''}
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // Update pagination
    function updatePagination(data) {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        if (data.TotalPages <= 1) return;

        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Previous</a>`;
        pagination.appendChild(prevLi);

        for (let i = 1; i <= data.TotalPages; i++) {
            if (i === 1 || i === data.TotalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>`;
                pagination.appendChild(li);
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                const li = document.createElement('li');
                li.className = 'page-item disabled';
                li.innerHTML = '<span class="page-link">...</span>';
                pagination.appendChild(li);
            }
        }

        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === data.TotalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Next</a>`;
        pagination.appendChild(nextLi);
    }

    // Change page
    function changePage(page) {
        currentPage = page;
        loadExecutions();
    }

    // Cancel execution
    async function cancelExecution(id) {
        if (!confirm('Are you sure you want to cancel this execution?')) return;

        try {
            const response = await fetch(`/api/spark-job-executions/${id}/cancel`, { method: 'POST' });
            if (response.ok) {
                alert('Execution cancelled successfully');
                loadExecutions();
                loadStatistics();
            } else {
                const error = await response.json();
                alert(`Error: ${error.error || 'Failed to cancel execution'}`);
            }
        } catch (error) {
            console.error('Error cancelling execution:', error);
            alert('Error cancelling execution: ' + error.message);
        }
    }

    // Toggle auto-refresh
    function toggleAutoRefresh() {
        const checkbox = document.getElementById('autoRefresh');
        if (checkbox.checked) {
            autoRefreshInterval = setInterval(() => {
                loadExecutions();
                loadStatistics();
            }, 30000); // 30 seconds
        } else {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
    }

    // Utility functions
    function getStatusBadge(status) {
        const badges = {
            'Queued': 'bg-secondary',
            'Submitting': 'bg-info',
            'Running': 'bg-primary',
            'Succeeded': 'bg-success',
            'Failed': 'bg-danger',
            'Cancelled': 'bg-warning'
        };
        const color = badges[status] || 'bg-secondary';
        return `<span class="badge ${color}">${status}</span>`;
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleString();
    }

    function calculateDuration(startDate, endDate) {
        if (!startDate) return '-';
        const start = new Date(startDate);
        const end = endDate ? new Date(endDate) : new Date();
        const seconds = Math.floor((end - start) / 1000);
        if (seconds < 60) return `${seconds}s`;
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}m ${seconds % 60}s`;
        const hours = Math.floor(minutes / 60);
        return `${hours}h ${minutes % 60}m`;
    }
</script>
}

